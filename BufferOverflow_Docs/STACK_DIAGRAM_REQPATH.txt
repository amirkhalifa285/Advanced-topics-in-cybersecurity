â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        STACK LAYOUT FOR process_client() - reqpath BUFFER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Function: process_client(int fd)
Location: zookd.c, lines 99-119
Vulnerable Buffer: char reqpath[4096]  (stack-allocated)
Vulnerable Function: url_decode() in http.c


HIGH MEMORY ADDRESS (Top of Stack)
â–²
â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  SAVED RIP (Return Address)                    â”‚
â”‚  â”‚  Points back to: run_server()                  â”‚  8 bytes
â”‚  â”‚  â˜… TARGET FOR EXPLOIT â˜…                        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚  SAVED RBP (Frame Pointer)                     â”‚  8 bytes
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚  Other saved registers                         â”‚  ~48 bytes
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚  const char *errmsg                            â”‚  8 bytes
â”‚  â”‚  (pointer to error message)                    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚                                                 â”‚
â”‚  â”‚  char reqpath[4096]                            â”‚
â”‚  â”‚  â˜… VULNERABLE BUFFER â˜…                         â”‚  4096 bytes
â”‚  â”‚                                                 â”‚
â”‚  â”‚  [0] [1] [2] ... [4095]                       â”‚
â”‚  â”‚                                                 â”‚
â”‚  â”‚  Filled by: url_decode(reqpath, url_path)     â”‚
â”‚  â”‚  url_decode() has NO BOUNDS CHECK!            â”‚
â”‚  â”‚                                                 â”‚
â”‚  â”‚  When we send 8000 'A's:                      â”‚
â”‚  â”‚  - Bytes 0-4095: Fill reqpath buffer          â”‚
â”‚  â”‚  - Bytes 4096+: OVERFLOW into stack above!    â”‚
â”‚  â”‚                                                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚  static size_t env_len (value)                â”‚  8 bytes
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚  int fd (parameter)                            â”‚  4 bytes
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
LOW MEMORY ADDRESS (stack grows downward)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MEMORY LAYOUT DURING OVERFLOW:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

BEFORE url_decode() call:
  reqpath[4096]: [uninitialized garbage data....................]
  errmsg:        [some pointer value]
  saved regs:    [legitimate register values]
  saved RBP:     [legitimate frame pointer]
  saved RIP:     [address in run_server() to return to]


DURING url_decode() with 8000 'A's:
  reqpath[4096]: [AAAAAAAAAAAAAAAAAAAAAAAAAAAA...] â† Bytes 0-4095
  OVERFLOW:      [AAAAAAAAAAA...]                 â† Bytes 4096-8000
                  â†“ overwrites everything above!
  errmsg:        [AAAAAAAA] = 0x4141414141414141  â† Corrupted!
  saved regs:    [AAAAAAAA] = 0x4141414141414141  â† Corrupted!
  saved RBP:     [AAAAAAAA] = 0x4141414141414141  â† Corrupted!
  saved RIP:     [AAAAAAAA] = 0x4141414141414141  â† Corrupted!


AFTER url_decode() returns:
  - process_client() tries to continue execution
  - May try to use 'errmsg' pointer â†’ CRASH (invalid address)
  - Or tries to call another function â†’ CRASH (corrupted stack)
  - Or tries to return to caller â†’ CRASH (RIP = 0x4141414141414141)
  
RESULT: General Protection Fault (signal 11)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EXPLOIT PAYLOAD STRUCTURE (exploit-2.py):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  'A' repeated 8000 times                                        â”‚
â”‚                                                                  â”‚
â”‚  Bytes 0-4095:    Fill reqpath buffer completely               â”‚
â”‚  Bytes 4096-8000: Overflow and corrupt stack                   â”‚
â”‚                   - Overwrites local variables                  â”‚
â”‚                   - Overwrites saved registers                  â”‚
â”‚                   - Overwrites saved RBP                        â”‚
â”‚                   - Overwrites saved RIP                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HTTP Request:
  GET /AAAA...[8000 A's]...AAAA HTTP/1.0\r\n\r\n

Python code:
  payload = b"A" * 8000
  request = b"GET /" + payload + b" HTTP/1.0\r\n\r\n"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

WHY THIS WORKS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. NO LENGTH CHECK before url_decode()
   - http_request_line() doesn't validate URL length
   - Just passes it directly to url_decode()

2. url_decode() has NO BOUNDS CHECK
   void url_decode(char *dst, const char *src) {
       for (;;) {
           *dst = *src;  // â† No check if dst is full!
           dst++;        // â† Keeps incrementing!
       }
   }

3. Stack is writable
   - All local variables are on stack
   - No stack canaries (compiled with -fno-stack-protector)
   - No ASLR (addresses are predictable)

4. Overflow is MASSIVE
   - 8000 bytes into 4096-byte buffer
   - 3904 bytes of overflow!
   - Guaranteed to corrupt return address
   - Impossible to miss!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


CALL STACK AT TIME OF CRASH:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

main()
  â””â”€â†’ run_server()
       â””â”€â†’ accept()
            â””â”€â†’ fork()
                 â””â”€â†’ [CHILD PROCESS]
                      â””â”€â†’ process_client()      â† Stack frame we overflow
                           â””â”€â†’ http_request_line()
                                â””â”€â†’ url_decode()  â† Overflow happens here!
                                     [Writes 8000 bytes]
                                     [Corrupts stack]
                                â†â”€â”€ Returns
                           â†â”€â”€ Tries to continue
                           ğŸ’¥ CRASH! (Invalid memory access)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

KEY INSIGHT:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

The vulnerability is in url_decode(), but the BUFFER being overflowed
is reqpath[4096] in the CALLER function (process_client).

This is a classic example of a vulnerable utility function (url_decode)
causing a buffer overflow in its caller's stack frame.

The lesson: ALWAYS validate buffer bounds, even in utility functions!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
