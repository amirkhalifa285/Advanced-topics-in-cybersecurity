#!/usr/bin/env python3

import rpclib
import sys
from debug import *
from zoodb import cred_setup, Cred

import hashlib
import random

class AuthRpcServer(rpclib.RpcServer):
    def rpc_newtoken(self, username, password):
        db = cred_setup()
        cred = db.get(Cred, username)
        if not cred:
            return None
        hashinput = "%s%.10f" % (password, random.random())
        cred.token = hashlib.md5(hashinput.encode('utf-8')).hexdigest()
        db.commit()
        return cred.token

    def rpc_login(self, username, password):
        db = cred_setup()
        cred = db.get(Cred, username)
        if not cred:
            return None
        if cred.password == password:
            return self.rpc_newtoken(username, password)
        else:
            return None

    def rpc_register(self, username, password):
        creddb = cred_setup()
        cred = creddb.get(Cred, username)
        if cred:
            return None

        newcred = Cred()
        newcred.username = username
        newcred.password = password
        creddb.add(newcred)
        creddb.commit()
        
        return self.rpc_newtoken(username, password)

    def rpc_check_token(self, username, token):
        db = cred_setup()
        cred = db.get(Cred, username)
        if cred and cred.token == token:
            return True
        else:
            return False

(_, dummy_zookld_fd, sockpath) = sys.argv

s = AuthRpcServer()